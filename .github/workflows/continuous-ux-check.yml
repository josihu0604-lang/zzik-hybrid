# GitHub Actions: Continuous UX/UI Check
#
# 30Î∂ÑÎßàÎã§ ÏûêÎèô Ïã§ÌñâÎêòÎäî UX/UI ÌíàÏßà Í≤ÄÏÇ¨
# - TypeScript ÌÉÄÏûÖ Ï≤¥ÌÅ¨
# - ESLint Í≤ÄÏÇ¨
# - Ï†ëÍ∑ºÏÑ± Í≤ÄÏÇ¨
# - ÌîÑÎ°úÎçïÏÖò Ìó¨Ïä§Ï≤¥ÌÅ¨
# - ÎπåÎìú Í≤ÄÏ¶ù

name: Continuous UX/UI Check

on:
  schedule:
    # Îß§ 30Î∂ÑÎßàÎã§ Ïã§Ìñâ
    - cron: '*/30 * * * *'

  # ÏàòÎèô Ïã§Ìñâ
  workflow_dispatch:
    inputs:
      full_check:
        description: 'Run full comprehensive check'
        required: false
        default: 'false'
        type: boolean

env:
  SKIP_ENV_VALIDATION: true
  NEXT_PUBLIC_APP_URL: https://zzik-hybrid.vercel.app

jobs:
  # ============================================
  # Quick Health Check (5Î∂Ñ ÎÇ¥)
  # ============================================
  health-check:
    name: üè• Production Health
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - name: Check Production Pages
        run: |
          echo "üîç Checking production pages..."

          PAGES="/ /live /map /me /popup/1 /login /leader"
          FAILED=0

          for page in $PAGES; do
            STATUS=$(curl -s -o /dev/null -w "%{http_code}" "https://zzik-hybrid.vercel.app${page}")
            if [ "$STATUS" != "200" ]; then
              echo "‚ùå ${page}: HTTP ${STATUS}"
              FAILED=$((FAILED + 1))
            else
              echo "‚úÖ ${page}: HTTP ${STATUS}"
            fi
          done

          if [ $FAILED -gt 0 ]; then
            echo "::error::${FAILED} pages failed health check!"
            exit 1
          fi

          echo "‚úÖ All pages healthy!"

  # ============================================
  # TypeScript & Lint Check
  # ============================================
  type-check:
    name: üìù TypeScript & Lint
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: TypeScript Check
        run: pnpm type-check

      - name: ESLint Check
        run: pnpm lint

  # ============================================
  # Build Verification
  # ============================================
  build-check:
    name: üèóÔ∏è Build Verification
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: [type-check]

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build
        run: pnpm build

      - name: Check Bundle Size
        run: |
          echo "üì¶ Bundle Size Analysis"
          echo "========================"

          # Check for large chunks
          LARGE_CHUNKS=$(find .next/static/chunks -name "*.js" -size +200k 2>/dev/null | wc -l)
          if [ "$LARGE_CHUNKS" -gt 5 ]; then
            echo "‚ö†Ô∏è Warning: ${LARGE_CHUNKS} chunks larger than 200KB"
          else
            echo "‚úÖ Bundle sizes within limits"
          fi

  # ============================================
  # Accessibility Audit
  # ============================================
  accessibility:
    name: ‚ôø Accessibility Audit
    runs-on: ubuntu-latest
    timeout-minutes: 10
    if: github.event.inputs.full_check == 'true' || github.event_name == 'schedule'

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Check ARIA Labels
        run: |
          echo "üîç Checking ARIA accessibility..."

          # Count interactive elements without aria-label
          MISSING=$(grep -rn "onClick=" src/app src/components --include="*.tsx" | grep -v "aria-label" | grep -v "role=" | wc -l)

          if [ "$MISSING" -gt 10 ]; then
            echo "‚ö†Ô∏è Warning: ${MISSING} onClick handlers without aria-label"
          else
            echo "‚úÖ ARIA labels look good (${MISSING} minor issues)"
          fi

      - name: Check Form Labels
        run: |
          echo "üîç Checking form accessibility..."

          # Count inputs without proper labeling
          UNLABELED=$(grep -rn "<input" src --include="*.tsx" | grep -v "id=" | grep -v "aria-label" | wc -l)

          if [ "$UNLABELED" -gt 5 ]; then
            echo "‚ö†Ô∏è Warning: ${UNLABELED} inputs without proper labeling"
          else
            echo "‚úÖ Form labels look good"
          fi

  # ============================================
  # Notification
  # ============================================
  notify:
    name: üì¢ Notify
    runs-on: ubuntu-latest
    needs: [health-check, type-check, build-check]
    if: failure()

    steps:
      - name: Notify on Failure
        run: |
          echo "üö® UX/UI Check Failed!"
          echo "Check the workflow logs for details."

          # Add Slack/Discord notification here if needed
          # curl -X POST ...

  # ============================================
  # Summary Report
  # ============================================
  summary:
    name: üìä Summary
    runs-on: ubuntu-latest
    needs: [health-check, type-check, build-check]
    if: always()

    steps:
      - name: Generate Summary
        run: |
          echo "## ZZIK UX/UI Check Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Check | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Health Check | ${{ needs.health-check.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| TypeScript | ${{ needs.type-check.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Build | ${{ needs.build-check.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "üïê Run at: $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
